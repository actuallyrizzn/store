# V2.5 Build Plan (Full Specification)

Clawed Road v2 shipped with core marketplace (browse, buy, orders) and minimal vendor/admin. This plan closes the gap with the same level of detail as the v2 planning docs: **nav**, **auth**, **user**, **store**, **vendor CMS**, **PMs**, **support**, **transactions**, **disputes**, and **staff**.

**Reference:** v1 (Tochka) lives in repo root (Go); planning docs for v2 are in [planning/v2/](v2/). Implement in **`app/`** (PHP web + API, Python cron unchanged unless noted). **Binding planning decisions:** [v2/08-PLANNING-DECISIONS-QA.md](v2/08-PLANNING-DECISIONS-QA.md).

---

## Executive Summary

### Scope (In Scope for v2.5)

| Area | Deliverables |
|------|--------------|
| **Nav** | Settings, Referrals, My store, Add item, Deposits (vendor-only); My orders (payments) for all; no “Wallet” (no in-app buyer wallets). |
| **Auth** | Password recovery (request → token → reset; token shown in UI; no email in v2.5); invite-code registration; auth admin (users list, ban, grant staff/seller). No impersonate in v2.5. |
| **User** | Public profile/about; user settings (password, preferences); store settings (storename, description, vendorship re-agree); referrals page; verification (agreement + plan). |
| **Store (vendor)** | Store settings (see User); reviews page; warnings page. |
| **Vendor CMS** | Deposits list/add/withdraw; item edit; item delete (soft). |
| **Board & Messages** | Private messages only: list conversations, thread, send/reply. |
| **Support** | Ticket list, new ticket, ticket thread (view + reply); staff can reply and set status. |
| **Transactions** | From payment page: actions shipping, release, cancel, complete (by role and status). |
| **Disputes** | Start dispute from tx page; dispute detail (view, claims, status); dispute admin list. |
| **Staff** | Full staff panel: dashboard, stores, tickets, disputes, warnings, deposits, stats, item categories (no user management—admin only). |

### Out of Scope for v2.5

- Shoutbox / public messageboard (PMs only).
- In-app buyer wallets / “fund from wallet” (per v2/08: buyer sends from external wallet only).
- Vendor referral payouts (roadmap per v2/08).
- Multisig / Gnosis Safe escrow (roadmap).
- 2FA (roadmap per v2/08).
- API scope expansion beyond what’s needed for above (existing API patterns reused).
- **Impersonate:** In this plan, "impersonate" means an admin (or staff) "login as user"—the session becomes that user for support/debug. **Excluded from v2.5** unless it serves a clear use case; roadmapped for later if needed.
- **Verification plan page** (gold/silver/bronze tiers): out; roadmap. Only vendorship agreement (re-agree) in scope.
- **Config to shorten auto-release when buyer confirmed:** out; roadmap.

### Roadmap (post–v2.5)

Items explicitly out of scope for v2.5; implement later if needed:

- **Impersonate** ("login as user")
- **Verification plan page** (gold/silver/bronze tiers)
- **Config to shorten auto-release** when buyer has confirmed

### Current State (app/ as of v2)

- **Public:** `app/public/` — LEMP, one script per page; `includes/` (Schema, User, Session, StatusMachine, web_header, web_footer, bootstrap).
- **Nav:** Header (`web_header.php`) shows Marketplace, Vendors, My orders, Create store, Admin (if admin), Logout/Login/Register. No Settings, Referrals, My store, Add item, or Wallet.
- **Auth:** Login, register, logout only. No recovery, no invite codes, no auth admin (admin has config + tokens only).
- **User:** No public profile page; no settings pages; no referrals page; no verification pages.
- **Store:** `store.php` shows store by uuid; no reviews or warnings tabs/pages.
- **Vendor CMS:** No deposits web UI; no item edit/delete web UI (API has items CRUD).
- **Messages:** None.
- **Support:** None.
- **Transactions:** `payment.php` shows one order (status, escrow); no shipping/release/cancel/complete actions.
- **Disputes:** API exists (`api/disputes.php`); no web “start dispute” or dispute detail or admin list.
- **Staff:** No staff panel (admin has `admin/index.php` for config/tokens only).

### Target State (After v2.5)

- Nav: logged-in users see Settings, Referrals, My orders (payments), and—if vendor—My store, Add item, Deposits; staff/admin see Staff link. No Wallet.
- Auth: recover password (request → token → reset; token shown in UI; no email in v2.5); register with optional invite code; admin can list users, ban, grant staff/seller. No impersonate in v2.5.
- User: public `/user.php?username=…`; settings/user, settings/store; referrals page; verification agreement + plan.
- Store: store page with reviews and warnings (tabs or subpages).
- Vendor CMS: deposits list/add/withdraw; item edit and item delete.
- PMs: list conversations, open thread, send/reply.
- Support: list tickets, new ticket, ticket thread; staff reply and set status.
- Transactions: payment page has buttons (shipping, release, cancel, complete) by role and status; POST handlers call StatusMachine / transaction intents.
- Disputes: “Open dispute” from payment page; dispute detail page; staff dispute list.
- Staff: staff dashboard and sections (stores, tickets, disputes, warnings, deposits, stats, categories). User management (list, ban, grant) is admin-only; staff escalate to Admin.

### Document Map (This Document)

- **§1 Nav** — Header links, vendor submenu (Deposits, not “Wallet”); files to change.
- **§2 Auth** — Password recovery, invite codes, auth admin; schema, flows, scripts.
- **§3 User** — Profile, user settings, store settings, referrals, verification; schema, URLs, flows.
- **§4 Store** — Reviews, warnings; schema, URLs.
- **§5 Vendor CMS** — Deposits, item edit/delete; URLs, API reuse.
- **§6 Board & Messages** — PMs only; schema, list/thread/send.
- **§7 Support** — Tickets; schema, list/new/thread.
- **§8 Transactions** — Shipping/release/cancel/complete on payment page; intents and StatusMachine.
- **§9 Disputes** — Start, detail, admin list; schema alignment.
- **§10 Staff** — Full panel; middleware, sections, URLs.
- **§11 Schema Changes Summary** — All new tables and columns in one place.
- **§12 Cross-Cutting** — API alignment, cron, security, **Security Baselines** (CSRF, rate limits), **Audit logging**.
- **§13 Order of Implementation** — Suggested sequence.

### Implementation principle (binding)

Where this plan leaves discretion: **do what makes sense**; avoid duplicate cruft; **KISS**. There are no live production systems yet—prefer simplicity. Do not create duplicate code paths for the same function as v2.

### Gating and Dependencies

- **Schema first:** Add any new tables (password_reset_tokens, invite_codes, reviews, store_warnings, support_tickets, support_ticket_messages, private_messages) before building pages that use them.
- **StatusMachine / transaction intents:** v2 already has `transaction_intents` and append-only status/shipping; use them for shipping/release/cancel/complete (PHP writes intents; Python cron performs chain actions per v2/05).
- **Access control (binding):** Staff panel requires role in (staff, admin). Admin-only routes require role = admin. Vendor = store_users membership only (no `vendor` in users.role). See **Role Matrix (Binding)**. Reuse `$currentUser` from Session; "is vendor?" = SELECT 1 FROM store_users WHERE user_uuid = ?.

### Decisions (binding)

- **Impersonate:** Out of scope for v2.5 (roadmap). Do not implement "login as user."
- **Staff and user management:** Staff does **not** do user management. User list, ban, grant staff/seller are **admin only**. Staff escalate to admin for user actions.
- **Dispute list:** One route only: **`/staff/disputes.php`**. Both staff and admin use it. Do not add `/admin/disputes.php`.
- **Referral and invite:** Same flow; consolidate. Referral link uses the same mechanism as invite codes (e.g. invite_codes row or user-scoped code). One consistent mechanism; KISS.
- **Verification plan page:** Out of scope; roadmap. Only `/verification/agreement.php` (vendorship re-agree) in v2.5.
- **Support ticket message rate limit:** **Per ticket** (20 messages per hour **per ticket**). Binding. Pick this rule only; do not use "per user across all tickets."
- **Multiple stores (binding):** If we allow multiple stores per user, a **store switcher is required**. Nav or "My stores" must let the user choose which store for My store / Add item / Deposits. No multi-store without a switcher.
- **Deposit add (binding):** PHP must **send** chain_id (and currency/crypto per existing deposits schema) to Python. Python **defines** allowed chain/network options dynamically; if nothing is defined, default is **ETH mainnet** (system default). Define the contract (what PHP sends) and keep it consistent; do **not** duplicate v2 logic for the same function. Schema: no new columns that duplicate v2.
- **Buyer-confirmed shortening:** Out of scope; roadmap. No config in v2.5 to shorten auto-release when buyer confirmed.
- **Review score:** **1–5** (binding). Do not change.
- **dispute_claims:** Add **user_uuid** (author) only; keep existing columns (e.g. claim, status). No duplicate body column; KISS.
- **stores.withdraw_address:** **Validate format** (EVM address) before save; reject invalid. Binding.

---

## Role Matrix (Binding)

**Roles (canonical, binding):** `admin`, `staff`, `customer` only. Stored in `users.role`. A user has exactly one of these three. **There is no `vendor` value in `users.role`.**

**Vendor (binding):** “Vendor” is **not** a user role; it is **purely** store membership. A user **is a vendor** (for nav, item CMS, deposits, tx actions) if and only if they have at least one row in `store_users` (any store). So: `user.role = customer` but they have a `store_users` row → they see My store, Add item, Deposits (no contradiction). `user.role = customer` with zero stores → customer only, no vendor UI. Implement “is vendor?” as “SELECT 1 FROM store_users WHERE user_uuid = ? LIMIT 1”; do **not** check `users.role = 'vendor'`.

**store_users.role:** Within a store, `store_users.role` is `owner` or `collaborator`. **Owner** can: edit store settings (storename, description, vendorship agreement), manage store-level data, and (per deposit rules below) request withdraw. **Owner and collaborator** can: add/edit/delete items for that store, list/add deposits, mark shipped / release for that store’s transactions. “My store” / “Add item” / “Deposits” in nav show for any user who has any `store_users` row.

**Staff vs admin:** Staff is **separate** from admin. Staff can: list/reply tickets, list/resolve disputes, list/resolve/ack warnings, list deposits, view stats, CRUD item categories. Admin can do everything staff can **plus**: list/ban/grant users (grant staff, grant seller), config and API tokens (`/admin/`). So: staff panel (`/staff/`) is available to both staff and admin; admin-only routes require `role = admin`. Staff do **not** do user management; escalate to admin. No impersonate in v2.5.

**Grant seller (binding):** “Grant seller” = create a store (if needed) and add the user to `store_users` as **owner**. Do **not** set `users.role = 'vendor'` (that value does not exist). The user remains `admin`, `staff`, or `customer`; they gain vendor capabilities by virtue of `store_users` membership.

**Allowed actions by route group (binding):**

| Route group | customer | vendor (for own store) | staff | admin |
|-------------|----------|------------------------|------|-------|
| Public (marketplace, store view, user profile) | ✓ | ✓ | ✓ | ✓ |
| My orders / payments (buyer) | ✓ (own) | ✓ (own as buyer) | ✓ | ✓ |
| Payment page actions (shipping, release, cancel, complete) | See State & Permission Matrix | See State & Permission Matrix | See State & Permission Matrix | See State & Permission Matrix |
| Settings (user, store), Referrals, Verification | ✓ (own) | ✓ (own; store settings if owner) | ✓ | ✓ |
| Deposits (list/add/withdraw) | — | ✓ (stores they belong to) | list only (staff) | list only (admin) |
| Item CMS (new/edit/delete) | — | ✓ (stores they belong to) | — | ✓ |
| Reviews (view; create after RELEASED) | ✓ (create if buyer) | ✓ (view store) | ✓ | ✓ |
| Warnings (view store; ack) | — | ✓ (view; ack if owner) | create, resolve, list | create, resolve, list |
| PMs (list, thread, send) | ✓ (own) | ✓ (own) | ✓ (own) | ✓ (own) |
| Support (list, new, thread, reply) | ✓ (own tickets) | ✓ (own tickets) | ✓ (all tickets; reply, set status) | ✓ (all tickets; reply, set status) |
| Disputes (start, view, add claim) | ✓ (buyer on tx) | ✓ (vendor on tx) | view all, resolve, partial refund | view all, resolve, partial refund |
| Staff panel (dashboard, stores, tickets, disputes, warnings, deposits, stats, categories) | — | — | ✓ | ✓ |
| Admin only (user list, ban, grant staff/seller, config, tokens) | — | — | — | ✓ |

---

## State & Permission Matrix (Binding)

This table is the **single source of truth** for which actions are allowed on the payment/transaction page, by **role**, **payment status**, **shipping status**, and **dispute status**. All UI buttons and POST handlers must derive from this matrix. No ad hoc permission checks.

**Axes:**

- **Payment status** (from latest `transaction_statuses`): `PENDING`, `COMPLETED`, `RELEASED`, `CANCELLED`, `FAILED`, `FROZEN`.
- **Shipping status** (from latest `shipping_statuses`): `DISPATCH PENDING`, `DISPATCHED`.
- **Dispute status:** `NONE` (no dispute linked), `OPEN` (dispute exists and not resolved), `RESOLVED`.
- **Role in context:** buyer (current user = `transactions.buyer_uuid`), vendor (current user in `store_users` for `transactions.store_uuid`), staff, admin.

**Allowed actions and effect:**

| Payment status | Shipping | Dispute | Buyer | Vendor | Staff/Admin | Action | Backend effect |
|----------------|----------|---------|-------|--------|------------|--------|----------------|
| PENDING | any | NONE | Cancel | — | Cancel (admin override) | Cancel | Insert intent CANCEL; Python refunds, sets CANCELLED. |
| PENDING | any | any | — | — | — | (no other actions) | |
| COMPLETED | DISPATCH PENDING | NONE | Confirm received; Open dispute | Mark shipped; Release; Open dispute | Mark shipped; Release; Open dispute | Mark shipped | Append shipping_status DISPATCHED. |
| COMPLETED | DISPATCH PENDING | NONE | same | same | same | Release | Insert intent RELEASE; Python pays out, sets RELEASED. |
| COMPLETED | DISPATCH PENDING | NONE | same | same | same | Confirm received | Set buyer_confirmed_at (or equivalent); annotation only (no shorten auto-release in v2.5); **does not** immediately release (release = vendor or auto-release). |
| COMPLETED | DISPATCHED | NONE | Confirm received; Open dispute | Release; Open dispute | Release; Open dispute | Release | Insert intent RELEASE. |
| COMPLETED | any | NONE | Open dispute | Open dispute | — | Open dispute | Create dispute, link to tx; **immediately** append transaction_status FROZEN (binding: dispute create → FROZEN). |
| FROZEN | any | OPEN | Add claim; (no release/cancel) | Add claim; (no release/cancel) | Resolve; Partial refund | Resolve / Partial refund | Staff only: set dispute status, insert PARTIAL_REFUND intent or close dispute; Python performs partial refund per v2/01. **PARTIAL_REFUND intent → on success set transaction status to CANCELLED (with receipt).** |
| RELEASED, CANCELLED, FAILED | any | any | — | — | — | (none) | Terminal; no actions. |

**Cancel semantics (binding):**

- **Buyer** may request **Cancel** only when payment status is **PENDING** (buyer has not yet paid, or wants to abort). Once COMPLETED, buyer cannot cancel; only “Confirm received” or “Open dispute.”
- **Vendor** does **not** get a “Cancel” button in v2.5; cron handles “COMPLETED + not dispatched in 72h → freeze” (v2/01). Vendor can “Mark shipped” or “Release.”
- **Staff/Admin** may request Cancel only when PENDING (e.g. support override); for COMPLETED/FROZEN, use dispute flow (resolve or partial refund).
- **If COMPLETED is not dispatched and enters FROZEN** (e.g. cron freeze after 72h), resolution is **via dispute flow only** (staff resolves or partial refund); there is no direct cancel action in COMPLETED. Do not reintroduce cancel-completed as a support override.

**Complete / “Confirm received” semantics (binding):**

- **Complete** = buyer confirms they received the goods. Stored as a timestamp (e.g. `buyer_confirmed_at` on transaction or a status row). It does **not** by itself trigger immediate release. Release is either: (1) vendor clicks **Release**, or (2) auto-release after `completed_duration` (cron). Optionally, config can shorten auto-release when buyer has confirmed; if so, document in config. Default v2.5: **Complete** is annotation only; release still requires vendor or cron.

---

## 1. Nav

### 1.1 Goal

Header shows **Settings**, **Referrals**, **My orders** (payments) for all logged-in users; **vendors** additionally see **My store**, **Add item**, **Deposits**. No Wallet. Optional: user dropdown (avatar + menu) instead of flat links. Staff/admin see **Staff** link to staff panel.

### 1.2 Current State

- **File:** `app/public/includes/web_header.php`.
- **Logged-in links today:** Marketplace, Vendors, My orders, Create store, Admin (if role === admin), Logout (username).
- **Missing:** Settings, Referrals, My store, Add item, Deposits (vendor-only). No “vendor check” (store_users) to show My store / Add item / Deposits only for vendors.

### 1.3 Target State

- **All logged-in users:** Settings, Referrals, My orders (payments). No “Wallet.”
- **Vendors only:** My store, Add item, Deposits (link to `/deposits.php`). Vendor = has at least one row in `store_users` for current user.
- **Staff/admin:** Staff link (e.g. `/staff/` or `/staff/index.php`). Admin additionally sees Admin (config/tokens).
- **Anonymous:** Unchanged (Marketplace, Vendors, Login, Register).

### 1.4 Schema

No new tables. **Queries:** (1) Resolve “my store” for current user: `SELECT store_uuid FROM store_users WHERE user_uuid = ? LIMIT 1` (or primary store by role; v2 has store_users with role). If user has multiple stores, **store switcher required**: nav or "My stores" must let user choose which store for My store / Add item / Deposits. Use first store only when single store.

### 1.5 URLs / Scripts

| Link | Target URL | Notes |
|------|------------|--------|
| Settings | `/settings/user` or `/settings.php` (user tab) | May be single settings page with tabs: user, store, API. |
| Referrals | `/referrals.php` | |
| My store | `/store.php?uuid={store_uuid}` | store_uuid from store_users. |
| Add item | `/item/new.php?store_uuid={store_uuid}` or `/store-admin/{store_uuid}/item/new` | Vendor only; store_uuid from store_users. |
| Deposits | `/deposits.php` | Vendor only; list/add/withdraw vendor deposits (no “Wallet”—no in-app buyer wallet in v2.5). |
| Staff | `/staff/` or `/staff/index.php` | Visible if role in (staff, admin). |

### 1.6 Implementation

1. **Extend `web_header.php`:**
   - For all logged-in: Settings, Referrals, My orders (existing payments link).
   - Query: `SELECT store_uuid FROM store_users WHERE user_uuid = ? LIMIT 1`. If row exists: add My store, Add item, **Deposits** (href `/deposits.php`). Do not add “Wallet.”
   - If role is staff or admin: add Staff link.
   - Optional: wrap user links in a dropdown (e.g. “Account” or username).
2. **No “Wallet” in v2.5:** Vendor funds = Deposits only. Buyer sees My orders (payments). No in-app buyer wallet; no Wallet link or balance in nav.

### 1.7 Files to Create/Modify

| Action | File |
|--------|------|
| Modify | `app/public/includes/web_header.php` — add links, vendor query, optional dropdown. |

### 1.8 Access Control

- All new nav links require `$currentUser`. Staff link requires role in (staff, admin). My store / Add item require store membership (store_users).

---

## 2. Auth

### 2.1 Goal

- **Password recovery:** User requests reset → receives token/link → sets new password (2-step flow).
- **Invite-code registration:** `register.php?invite=CODE`; validate code; allow or restrict registration; record code usage.
- **Auth admin:** Admin-only: list users, view user, ban user, grant staff, grant seller (store). No impersonate in v2.5.
### 2.2 Current State

- **Login/Register/Logout:** `app/public/login.php`, `register.php`, `logout.php`; Session, User in includes. No recovery, no invite codes.
- **Admin:** `app/public/admin/index.php` (config, tokens); no user list or user actions.
- **Schema:** `users` has uuid, username, passphrase_hash, role, inviter_uuid, banned, etc. No `password_reset_tokens`, no `invite_codes`.

### 2.3 Target State

- **Recovery:** Step 1: request reset (username only (no email in v2.5)); create token; display reset link in UI. Step 2: open link with token, set new password, invalidate token.
- **Invite:** Register page accepts `?invite=CODE`; validate code; store used_by, used_at; optional: require invite to register (configurable).
- **Auth admin:** `admin/users.php` — list users (table: username, role, banned, created_at); link to user detail; user detail: ban, grant staff, grant seller (create store or add to store_users). No impersonate in v2.5.

### 2.4 Schema

**New tables:**

- **password_reset_tokens**
  - `id` (PK), `user_uuid` (FK users), `token` (unique, index), `expires_at` (TEXT), `created_at` (TEXT).
  - One active token per user or allow multiple; on use delete or mark used.
- **invite_codes**
  - `id` (PK), `code` (TEXT unique, index), `created_by_user_uuid` (FK users, nullable), `used_by_user_uuid` (FK users, nullable), `used_at` (TEXT nullable), `created_at` (TEXT).
  - Validate: code exists, used_at IS NULL; on register set used_by_user_uuid, used_at.

**Users:** Already has `banned`, `role`. “Grant seller” = ensure user has a store (create store or add to store_users); may need “default store” or single store per user for “Add item” in nav.

### 2.5 URLs / Scripts

| Page | URL | Method | Notes |
|------|-----|--------|--------|
| Request reset | `/recover.php` | GET form, POST submit | Submit username; create token; display reset link in UI (no email in v2.5). |
| Reset password | `/recover.php?token=…` or `/recover_step2.php?token=…` | GET form, POST submit | Validate token, set new password, delete token. |
| Register with invite | `/register.php?invite=CODE` | GET prefill, POST same | Validate code on POST; record use on success. |
| Auth admin list | `/admin/users.php` | GET | List users; admin only. |
| Auth admin user | `/admin/users.php?uuid=…` or `?username=…` | GET + POST | User detail; POST actions: ban, set role staff, grant seller (store). No impersonate. |

### 2.6 Flows

**Password recovery (v2.5 binding):**

- **Username-only; no email in v2.5.** Do not add an email column or SMTP for recovery. One path only: username → create token → **display reset link in the UI** (no email sent).
1. User visits `/recover.php`, enters username.
2. POST: find user by username; create row in `password_reset_tokens` (token = random 32 bytes hex, expires_at = now + 1 hour). **Display** the reset link on the same page (e.g. “Reset link: [base URL]/recover.php?token=… — copy and open; link expires in 1 hour”). Do not branch on “if email exists”; there is no email in v2.5.
3. User opens link; GET shows form “New password”. POST: validate token (exists, not expired), update user passphrase_hash, delete token, redirect to login.

**Invite registration:**

1. User visits `/register.php?invite=CODE`. GET: validate code (exists, used_at IS NULL); if invalid, show error or redirect to register without invite.
2. POST register: validate invite again; create user; set invite_codes.used_by_user_uuid = new user uuid, used_at = now. If registration required invite, reject if no valid code.

**Auth admin:**

1. Admin GET `/admin/users.php`: list users (paginated), columns: username, uuid, role, banned, created_at.
2. Admin clicks user → GET `/admin/users.php?username=…`: show user detail + actions (Ban, Set role to staff, Grant seller). POST: apply action (update users.banned, users.role; or create store + store_users for “grant seller”).
### 2.7 Security

- Reset token: single-use, short expiry (e.g. 1 hour); secure random token.
- Invite codes: don’t expose full list to non-admin; validate on server.
- Auth admin: restrict to role admin only (staff do not manage users; escalate to admin). No impersonate in v2.5; if added later, log in audit_log.

### 2.8 Files to Create/Modify

| Action | File |
|--------|------|
| Create | `app/public/recover.php` — request + reset (same script: step 2 when token present). |
| Modify | `app/public/register.php` — accept invite param, validate and consume invite code. |
| Create | `app/public/admin/users.php` — list users; user detail + ban/staff/seller. No impersonate. |
| Modify | `app/public/includes/Schema.php` — add createPasswordResetTokens(), createInviteCodes(). |
| Modify | `app/public/schema.php` (or migration) — run new schema. |

### 2.9 Edge Cases

- Recovery: unknown username → show generic “If that user exists, a link was sent” (no user enumeration).
- Invite: multiple use — one code = one use (used_at set once).
- Grant seller: if user already has store, “Grant seller” is no-op or show “Already has store”.

---

## 3. User

### 3.1 Goal

- **Profile / about:** Public page for a user (username, join date, feedback count if we have it; link to their store if vendor).
- **User settings:** Change password, email (if added), preferences.
- **Store settings:** Store name, description, vendorship re-agree (only for store owner).
- **Referrals:** Referral link, referred users list, referral earnings (if referral_payments used).
- **Verification:** Vendorship agreement (re-agree + timestamp); optional verification “plan” (gold/silver/bronze) page.

### 3.2 Current State

- No `user.php` (public profile). No `settings/` routes. No `referrals.php`. No verification pages. `users` has inviter_uuid; `stores` has vendorship_agreed_at; `referral_payments` exists.

### 3.3 Target State

- Public profile at `/user.php?username=…`. Settings: `/settings/user.php` (password, prefs), `/settings/store.php` (store; store owner only). Referrals: `/referrals.php`. Verification: `/verification/agreement.php` (re-agree) only. No plan page in v2.5.

### 3.4 Schema

- **Users:** Already has created_at, inviter_uuid. Optional: add email (TEXT) for recovery and display; if not in v2.5, recovery by username only.
- **Stores:** Already has storename, description, vendorship_agreed_at. Store settings just update these.
- **Referral_payments:** Exists; referrals page JOIN referral_payments with users to show earnings. “Referred users”: SELECT * FROM users WHERE inviter_uuid = ?.
- No new tables required for profile/settings/referrals/agreement. Verification “plan” might be config or separate table (e.g. account_tiers); can be read-only page for v2.5.

### 3.5 URLs / Scripts

| Page | URL | Method | Notes |
|------|-----|--------|--------|
| Profile | `/user.php?username=…` | GET | Public; show username, created_at, “Member since”; if vendor link to store. |
| User settings | `/settings/user.php` | GET form, POST | Change password; optional email/prefs. |
| Store settings | `/settings/store.php` | GET form, POST | store_uuid from store_users (owner); update storename, description; re-agree vendorship (update vendorship_agreed_at). |
| Referrals | `/referrals.php` | GET | Referral link (e.g. /register.php?invite=USER_REFCODE or site ref code); list referred users; list referral_payments for current user. |
| Agreement | `/verification/agreement.php` | GET + POST | Show agreement text; POST sets stores.vendorship_agreed_at for user’s store(s). |
| Plan | `/verification/plan.php` | GET | Info on tiers (gold/silver/bronze); optional purchase later. |

### 3.6 Flows

- **Profile:** GET user by username; 404 if not found; render. If user has store (store_users), query store and link to `/store.php?uuid=…`.
- **User settings:** POST: validate current password, set new password (hash), redirect.
- **Store settings:** Resolve store for current user (store_users); POST: update stores.storename, description; if “I agree” checkbox, set vendorship_agreed_at = now.
- **Referrals:** Same mechanism as invite codes; consolidate (KISS). Referral link = invite code or user-scoped code; one consistent flow. List: SELECT * FROM users WHERE inviter_uuid = current_user. List earnings: SELECT * FROM referral_payments WHERE user_uuid = current_user.
- **Agreement:** POST: update vendorship_agreed_at for user’s store(s).

### 3.7 Files to Create/Modify

| Action | File |
|--------|------|
| Create | `app/public/user.php` — public profile by username. |
| Create | `app/public/settings/user.php` — change password (and prefs if any). |
| Create | `app/public/settings/store.php` — store settings (store owner). |
| Create | `app/public/referrals.php` — referral link, referred users, earnings. |
| Create | `app/public/verification/agreement.php` — vendorship re-agree. |
| Create | `app/public/verification/plan.php` — tier info (static or from config). |

### 3.8 Access Control

- Profile: public. User/store settings: require $currentUser; store settings require store ownership. Referrals: current user only. Verification: current user, store owner for agreement.

---

## 4. Store (Vendor)

### 4.1 Goal

- Store settings: see User § Store settings.
- **Reviews page:** List reviews for the store (rater, transaction, score, comment).
- **Warnings page:** List warnings for the store; allow resolve/ack.

### 4.2 Current State

- `store.php` shows store by uuid (storename, description, etc.). No reviews or warnings in schema or UI.

### 4.3 Target State

- Store page: add tab or subpage for Reviews and Warnings. `/store.php?uuid=…&tab=reviews` or `/store/reviews.php?uuid=…`, `/store/warnings.php?uuid=…`.

### 4.4 Schema

**New tables:**

- **reviews**
  - `id` (PK), `transaction_uuid` (FK transactions), `store_uuid` (FK stores), `rater_user_uuid` (FK users, buyer), `score` (INTEGER 1–5 or similar), `comment` (TEXT), `created_at` (TEXT).
  - One review per transaction (buyer rates after complete). Index store_uuid for listing.
- **store_warnings**
  - `id` (PK), `store_uuid` (FK stores), `author_user_uuid` (FK users, staff), `message` (TEXT), `status` (e.g. open, resolved, acked), `created_at`, `updated_at`, `resolved_at` (TEXT nullable).
  - Index store_uuid. Staff create and resolve; vendor can ack only (per §4.4 binding).

### 4.5 URLs / Scripts

| Page | URL | Notes |
|------|-----|--------|
| Store reviews | `/store.php?uuid=…&tab=reviews` or `/store/reviews.php?uuid=…` | List reviews for store; public or store members. |
| Store warnings | `/store/warnings.php?uuid=…` or tab | List warnings; vendor/staff see; staff can add/resolve. |

### 4.6 Implementation

- Add `createReviews()`, `createStoreWarnings()` to Schema. Run migration.
- Reviews: list WHERE store_uuid = ? ORDER BY created_at DESC. “Add review” from transaction page when status = RELEASED (buyer only, one per tx).
- Warnings: list WHERE store_uuid = ?. Create from staff panel; resolve/ack via POST.

### 4.7 Files to Create/Modify

| Action | File |
|--------|------|
| Modify | `app/public/includes/Schema.php` — createReviews(), createStoreWarnings(). |
| Create or modify | `app/public/store.php` — add tabs or links to reviews/warnings; or `app/public/store/reviews.php`, `app/public/store/warnings.php`. |

---

## 5. Vendor CMS

### 5.1 Goal

- **Deposits:** List my stores’ deposits; add deposit (create address/record); withdraw (request withdraw; Python cron may perform).
- **Item edit:** Form to edit item (name, description, store_uuid); owner or store member only.
- **Item delete:** Soft-delete (set items.deleted_at).

### 5.2 Current State

- API: `api/deposits.php`, `api/items.php` exist. No web UI for deposits or item edit/delete.

### 5.3 Target State

- Web: deposits list, add, withdraw; item edit form; item delete button (or action on edit page).

### 5.4 Schema

- **Deposits / deposit_history:** Already exist. Add deposit = PHP creates row with store_uuid, **sends** chain_id (and currency/crypto per existing schema); Python defines allowed options dynamically; default ETH mainnet if none defined. PHP sets address = NULL; Python cron fills address. Withdraw = `deposit_withdraw_intents`; Python cron performs (see **5.4.1 Withdraw binding**). Keep schema consistent with v2; no duplicate columns or duplicate v2 logic.
- **Items:** Already has deleted_at. Soft-delete = set deleted_at = now.

### 5.4.1 Deposit withdraw (binding)

Implementers must follow this in §5; do not build a withdraw form with a free-text address field.

- **Store must have `stores.withdraw_address`.** One EVM address per store; withdrawals from that store's deposits go **only** to this address. Store owner sets it in store settings. If the store has no `withdraw_address`, **reject** the withdraw request (require store owner to set it first).
- **Owner only** can request withdraw. User must have `store_users` row for that store with `role = 'owner'`. Collaborators may list/add deposits but **cannot** create withdraw intents.
- **System sets `to_address`.** When creating a withdraw intent, PHP sets `to_address = (SELECT withdraw_address FROM stores WHERE uuid = (SELECT store_uuid FROM deposits WHERE uuid = ?))`. **No user input** for address. The withdraw UI must **not** let the user type an arbitrary address.
- **If missing `withdraw_address` → reject.** Return an error (e.g. "Set withdraw address in store settings first").

### 5.5 URLs / Scripts

| Page | URL | Method |
|------|-----|--------|
| Deposits list | `/deposits.php` | GET — list deposits for my stores (via store_users). |
| Add deposit | `/deposits/add.php` or `/deposits.php?action=add` | GET form, POST — create deposit (call API or duplicate logic). |
| Withdraw | `/deposits/withdraw.php?uuid=…` | GET + POST — request withdraw for deposit uuid. |
| Item edit | `/item/edit.php?uuid=…` | GET form, POST save. |
| Item delete | POST to `/item/edit.php?uuid=…&action=delete` or `/item/delete.php` | POST — set deleted_at. |

### 5.6 Implementation

- Deposits: reuse API logic (include API helpers or internal functions). List: JOIN deposits with store_users WHERE user_uuid = current.
- Item edit: load item; check store membership; form name, description; POST update items SET name, description, updated_at. Delete: POST set deleted_at.

### 5.7 Files to Create/Modify

| Action | File |
|--------|------|
| Create | `app/public/deposits.php` — list; optional add form on same page. |
| Create | `app/public/deposits/add.php` — add deposit. |
| Create | `app/public/deposits/withdraw.php` — withdraw request. |
| Create | `app/public/item/edit.php` — edit + delete action. |

---

## 6. Board & Messages (PMs Only)

### 6.1 Goal

Private messages only: list conversations (distinct peers), open thread with a user, send/reply.

### 6.2 Current State

No messages in app.

### 6.3 Schema

**New table: private_messages**

- `id` (PK), `from_user_uuid` (FK users), `to_user_uuid` (FK users), `body` (TEXT), `read_at` (TEXT nullable), `created_at` (TEXT).
- **Max body length (binding):** 10_000 characters. Reject longer on POST.
- **Indexes (binding):** `(from_user_uuid, created_at)`, `(to_user_uuid, created_at)` for thread and list queries. Optional: index for “last message per conversation” (e.g. `(LEAST(from_user_uuid, to_user_uuid), GREATEST(from_user_uuid, to_user_uuid), created_at)`) or compute distinct peers with subquery; ensure list query is O(messages per user) not O(N²).
- **Pagination (binding):** Thread view: 50 messages per page (default); `?page=2` etc. Conversation list: 50 conversations per page.
- **Retention / deletion:** v2.5: no user-facing delete. No soft-delete per user. If needed later, add `deleted_by_sender_at` / `deleted_by_recipient_at` and filter in SELECT.
- **Abuse / rate limiting (binding):** Rate limit PM send: 10 messages per minute per user (per user_uuid). Return 429 when exceeded. Optional: per-recipient limit (e.g. 5/min to same user) to curb spam.

### 6.4 URLs / Scripts

| Page | URL | Method |
|------|-----|--------|
| PM list | `/messages.php` | GET — list conversations (last message preview, unread count). |
| PM thread | `/messages.php?username=…` or `?peer=…` | GET — thread with that user; POST — send message. |

### 6.5 Implementation

- List: SELECT distinct peer, last message, unread count WHERE from_user_uuid = ? OR to_user_uuid = ?. Order by last message time. Paginate 50 per page. Use indexes above.
- Thread: GET messages WHERE (from,to) = (me, peer) OR (to,from) = (me, peer) ORDER BY created_at DESC LIMIT 50 OFFSET (page-1)*50. POST: validate body length ≤ 10_000; rate limit 10/min per user; insert private_messages; set read_at on recipient when viewing (optional).

### 6.6 Files to Create/Modify

| Action | File |
|--------|------|
| Modify | Schema — createPrivateMessages(). |
| Create | `app/public/messages.php` — list + thread by query param. |

---

## 7. Support

### 7.1 Goal

Ticket list, new ticket, ticket thread (view + reply). Staff can reply and set status.

### 7.2 Schema

**New tables:**

- **support_tickets**
  - `id` (PK), `user_uuid` (FK users), `subject` (TEXT), `status` (TEXT: open, closed, etc.), `created_at`, `updated_at`.
- **support_ticket_messages**
  - `id` (PK), `ticket_id` (FK support_tickets), `user_uuid` (FK users), `body` (TEXT), `created_at`.

**Pagination, limits, indexes (binding):**

- **Max body length:** 10_000 characters for ticket message body; reject longer on POST.
- **Indexes:** `support_ticket_messages(ticket_id, created_at)` for thread listing.
- **Pagination:** Ticket list: 50 per page. Ticket thread: 50 messages per page.
- **Retention:** v2.5: no deletion. No soft-delete. Add later if needed.
- **Abuse / rate limiting:** Rate limit ticket creation: 5 new tickets per hour per user. Rate limit message send: **20 messages per hour per ticket** (binding). Return 429 when exceeded.

### 7.3 URLs / Scripts

| Page | URL | Method |
|------|-----|--------|
| List | `/support.php` | GET — my tickets. |
| New | `/support/new.php` | GET form, POST — create ticket + first message. |
| Thread | `/support/ticket.php?id=…` | GET — messages; POST — add message; staff can set status. |

### 7.4 Files to Create/Modify

| Action | File |
|--------|------|
| Modify | Schema — createSupportTickets(), createSupportTicketMessages(). |
| Create | `app/public/support.php`, `app/public/support/new.php`, `app/public/support/ticket.php`. |

---

## 8. Transactions

### 8.1 Goal

From transaction (payment) page: actions **shipping**, **release**, **cancel**, **complete** (and **Open dispute**) by role and current status. **All allowed actions and semantics are binding in the State & Permission Matrix** (§ State & Permission Matrix). No ad hoc checks.

### 8.2 Current State

- `payment.php`: shows order (uuid, status, escrow); buyer or vendor can view. No buttons for shipping/release/cancel/complete.
- `transaction_intents` table exists; StatusMachine and append-only status/shipping exist. Python cron picks intents and performs chain actions.

### 8.3 Target State

- Payment page shows **only** the buttons allowed by the State & Permission Matrix for (current role, payment_status, shipping_status, dispute_status). Use the matrix as the single source of truth.
- **Cancel:** Buyer only when PENDING; staff/admin can cancel when PENDING (override). Vendor has no Cancel button; cron handles “completed but not dispatched in 72h → freeze.”
- **Complete (“Confirm received”):** Buyer only when COMPLETED. Effect: set `buyer_confirmed_at` (or equivalent); does **not** by itself trigger release. Release = vendor Release button or auto-release after completed_duration.
- POST handlers: validate (role, payment_status, shipping_status, dispute_status) against matrix; then insert intent or append shipping_status; redirect back to payment page.

### 8.4 Flows

- **Mark shipped:** Allowed per matrix (vendor/staff/admin when COMPLETED). POST → append shipping_status (DISPATCHED, user_uuid).
- **Release:** Allowed per matrix. POST → insert transaction_intents (action=RELEASE); Python cron performs.
- **Cancel:** Allowed per matrix (buyer or staff/admin when PENDING only). POST → insert transaction_intents (action=CANCEL); Python cron performs.
- **Confirm received:** Allowed per matrix (buyer when COMPLETED). POST → set buyer_confirmed_at (add column or status row); no intent.
- **Open dispute:** Link to dispute start; create dispute and link to transaction. **Binding:** Creating a dispute immediately sets transaction status to FROZEN (append transaction_status row).

### 8.5 Files to Create/Modify

| Action | File |
|--------|------|
| Modify | `app/public/payment.php` — add buttons (by role + current_status); add POST handler or include form that POSTs to same page or `payment/action.php`. |
| Create (optional) | `app/public/payment/action.php` — POST only; validate; call StatusMachine/intent; redirect to payment.php?uuid=…. |

### 8.6 Security

- Only buyer or vendor (store_users) or admin can perform actions. Validate current status allows transition (e.g. release only when COMPLETED).

---

## 9. Disputes

### 9.1 Goal

Start dispute from transaction page; dispute detail (view, claims, status); dispute admin list for staff.

### 9.2 Current State

- Schema: `disputes`, `dispute_claims` exist. API: `api/disputes.php`. No web: start dispute, detail page, admin list.

### 9.3 Target State

- Payment page: “Open dispute” link → form (reason, message) → POST create dispute + first claim. Link dispute to transaction (transactions.dispute_uuid).
- Dispute detail: `dispute.php?uuid=…` — show dispute, claims; buyer/vendor add claim; staff set status, partial refund (per v2/01).
- Admin list: `admin/disputes.php` or `staff/disputes.php` — list all disputes; link to detail.

### 9.4 Schema

- Disputes: ensure transaction_uuid or link via transaction.dispute_uuid. v2 disputes have uuid, status, resolver_user_uuid. Dispute_claims: dispute_uuid, user_uuid, body, etc. Add transaction_uuid to disputes if not present for “start from tx” flow.

### 9.5 URLs / Scripts

| Page | URL | Notes |
|------|-----|--------|
| Start dispute | From payment: link to `/dispute/new.php?transaction_uuid=…` or form on payment. | POST create dispute, set transaction.dispute_uuid, insert first claim. |
| Dispute detail | `/dispute.php?uuid=…` | GET view; POST add claim; staff POST status, partial_refund. |
| Admin list | `/staff/disputes.php` only (staff and admin both use it) | List disputes; link to detail. |

### 9.6 Files to Create/Modify

| Action | File |
|--------|------|
| Create | `app/public/dispute/new.php` — form + POST start dispute. |
| Create | `app/public/dispute.php` — detail by uuid; add claim; staff actions. |
| Create | `app/public/staff/disputes.php` — list disputes (staff and admin; no separate admin/disputes.php). |
| Modify | `app/public/payment.php` — add “Open dispute” link when applicable (e.g. COMPLETED/FROZEN). |

---

## 10. Staff

### 10.1 Goal

Full staff panel: dashboard, users, stores, tickets, disputes, warnings, deposits, stats, item categories. Middleware: require role staff or admin.

### 10.2 Current State

- Admin: `admin/index.php` (config, tokens). No staff panel.

### 10.3 Target State

- All under `/staff/`. Dashboard with links to each section. Sections: **stores** (list, detail, suspend, tiers), **tickets** (list, open thread, reply, status), **disputes** (list, link to detail), **warnings** (list, resolve/ack), **deposits** (list), **stats** (tables/charts), **categories** (CRUD item_categories). **No user management in staff panel**—user list, ban, grant staff/seller are admin-only at `/admin/users.php`; staff escalate to Admin.

### 10.4 URLs / Scripts

| Section | URL | Notes |
|---------|-----|--------|
| Dashboard | `/staff/index.php` | Links to sections (no users—user management is admin-only). |
| Stores | `/staff/stores.php`, `/staff/stores.php?uuid=…` | List; detail + suspend, tier. |
| Tickets | `/staff/tickets.php`, `/staff/tickets.php?id=…` | List; thread + reply, status. |
| Disputes | `/staff/disputes.php` | List; link to dispute.php. |
| Warnings | `/staff/warnings.php` | List store_warnings; add, resolve. |
| Deposits | `/staff/deposits.php` | List all or by store. |
| Stats | `/staff/stats.php` | Simple tables or charts (counts, volume). |
| Categories | `/staff/categories.php` | CRUD item_categories. |

### 10.5 Implementation

- Middleware: at top of each staff script, require $currentUser and role in (staff, admin). Redirect to login or 403 otherwise.
- Reuse or mirror v1 staff views; keep LEMP (one script per page or section). Stats: SELECT counts from transactions, users, stores; optional chart lib (e.g. simple HTML table first).

### 10.6 Files to Create/Modify

| Action | File |
|--------|------|
| Create | `app/public/staff/index.php` — dashboard. |
| Create | `app/public/staff/stores.php`, `tickets.php`, `disputes.php`, `warnings.php`, `deposits.php`, `stats.php`, `categories.php`. (No staff/users—user management is `/admin/users.php` only.) |
| Modify | Nav — add Staff link for staff/admin. |

---

## 11. Schema Changes Summary

All new or changed schema for v2.5 in one place. Add to `app/public/includes/Schema.php` and run (e.g. via `schema.php` or migration).

| Table | Purpose |
|-------|---------|
| **password_reset_tokens** | id, user_uuid, token (unique), expires_at, created_at |
| **invite_codes** | id, code (unique), created_by_user_uuid, used_by_user_uuid, used_at, created_at |
| **reviews** | id, transaction_uuid (UNIQUE), store_uuid, rater_user_uuid, score, comment, created_at |
| **store_warnings** | id, store_uuid, author_user_uuid, message, status (open/acked/resolved), created_at, updated_at, resolved_at, acked_at |
| **support_tickets** | id, user_uuid, subject, status, created_at, updated_at |
| **support_ticket_messages** | id, ticket_id, user_uuid, body, created_at |
| **private_messages** | id, from_user_uuid, to_user_uuid, body, read_at, created_at |
| **deposit_withdraw_intents** | id, deposit_uuid, to_address (set from stores.withdraw_address only; no user input), requested_at, requested_by_user_uuid, status (pending/completed/failed), created_at |
| **audit_log** | id, actor_user_uuid, action_type, target_type, target_id, metadata (JSON), created_at |

**Existing tables (changes for v2.5):** **stores** — add `withdraw_address` (TEXT nullable) for deposit withdraw binding. **transactions** — add `buyer_confirmed_at` (TEXT nullable) for “Confirm received”. **disputes** — add `transaction_uuid` (FK to transactions) if missing. **dispute_claims** — add `user_uuid` (FK users, author of claim) if missing. Keep existing columns (e.g. claim, status); no duplicate body column. KISS. **Existing table (required by staff/categories; ensure created in schema run):** **item_categories** — id, name_en, parent_id. Staff panel CRUD uses it. If your v2 schema creation (e.g. Schema.php createItemCategories) does not already create this table, add it to the schema run so a fresh environment has it; otherwise staff categories will break. Other tables (users, store_users, items, packages, transaction_statuses, shipping_statuses, transaction_intents, deposits, deposit_history, referral_payments, api_keys, config): no structural change unless noted.

---

## 12. Cross-Cutting

### 12.1 API Alignment

- Existing API: auth-user, deposits, disputes, items, stores, transactions, keys, etc. Add or extend only where needed for above features (e.g. support tickets, messages) if agents need them. Prefer web-first; API can follow same logic.

### 12.2 Cron

- **Transaction intents:** Already handled by Python (release, cancel). No change unless new action types.
- **Deposits (v2.5):** Python cron must: (1) fill `deposits.address` for rows with address NULL (HD-derived); (2) update deposit balances from chain; (3) process `deposit_withdraw_intents` (pending → send from deposit address to to_address, write history, set intent completed/failed). Add these to cron if not already present.
- **PHP cron (optional):** Expire password_reset_tokens (delete where expires_at < now); optional cleanup of old audit_log (retention policy later).

### 12.3 Security

- All new pages: require auth where appropriate; validate ownership (store, transaction, ticket). Staff routes: require staff or admin role. Reset tokens: single-use, expiry. Invite codes: server-side validate. No PGP/dark-web references.

### 12.4 Security Baselines (binding)

**CSRF:** Every web POST (forms that change state) must be CSRF-protected. Use a per-session or per-request token in the form; validate on POST. No exception for “internal” forms. Apply to: login, register, recover, settings, store settings, item edit/delete, deposits add/withdraw, payment actions (shipping, release, cancel, complete), dispute start/add claim, support new ticket/ticket reply, PM send, staff actions (ban, grant, ticket status, dispute resolve, warning create/resolve, etc.). No impersonate in v2.5.

**Rate limiting (binding):**

| Flow | Limit | Key | Response when exceeded |
|------|--------|-----|--------------------------|
| Password reset request | 5 per hour | per IP | 429 or generic “If that user exists, a link was sent” (no enumeration) |
| Login attempts | 10 per 5 minutes | per IP | 429 or delay + generic “Invalid credentials” |
| PM send | 10 per minute | per user_uuid | 429 |
| Support ticket create | 5 per hour | per user_uuid | 429 |
| Support ticket message | 20 per hour | per ticket | 429 |

Throttle recovery by IP to avoid enumeration and abuse; throttle PM/ticket by user to avoid spam. No user enumeration on recovery (same message for valid/invalid username).

### 12.5 Audit logging (binding)

Write to **audit_log** (actor_user_uuid, action_type, target_type, target_id, metadata JSON, created_at) for all staff/admin actions that change authority or money-related state. No fancy UI required in v2.5; just persist rows for debugging and compliance.

**Log at least:**

- user_ban (target_type=user, target_id=user_uuid)
- grant_staff, grant_seller (target_type=user, target_id=user_uuid)
- impersonate (target_type=user, target_id=impersonated user_uuid; metadata: who impersonated)
- dispute_resolve, dispute_partial_refund (target_type=dispute, target_id=dispute_uuid)
- warning_create, warning_resolve (target_type=store_warning, target_id=warning id)
- ticket_status_change (target_type=support_ticket, target_id=ticket id; metadata: old_status, new_status)

Optional: log release/cancel intents (target_type=transaction, action_type=release_request/cancel_request) for audit trail. Implement a small helper (e.g. `AuditLog::write($pdo, $actorUuid, $actionType, $targetType, $targetId, $metadata)`) and call it from the same code paths that perform the action.

### 12.6 Localization

- v2 has i18n data under `data/i18n/`. Add strings for new UI (Settings, Referrals, My store, Add item, Deposits, Recovery, Invite, Staff, etc.) as needed; can start with EN only.

---

## 13. Order of Implementation (Suggested)

1. **Schema** — Add **all** schema deltas before any UI work. **New tables:** password_reset_tokens, invite_codes, reviews, store_warnings, support_tickets, support_ticket_messages, private_messages, deposit_withdraw_intents, audit_log. **New columns:** stores.withdraw_address (TEXT nullable), transactions.buyer_confirmed_at (TEXT nullable), disputes.transaction_uuid (FK transactions) if missing, dispute_claims.user_uuid (FK users) if missing. **Ensure item_categories exists** (id, name_en, parent_id)—required by staff categories; create in schema run if not already present so fresh environments do not break. Add indexes per §6, §7, §11. Run migration. Do not start Nav/User/Auth until this step is complete so agents do not hit missing-table or missing-column bugs mid-phase.
2. **Nav** — Extend web_header: Settings, Referrals, My orders, My store, Add item, Deposits (vendor-only), Staff. No Wallet. Quick win.
3. **User** — Profile, user settings, store settings, referrals, verification agreement (and plan page). Enables Settings link.
4. **Auth** — Recovery (username-only; token shown in UI; no email in v2.5), invite registration, admin users (list, ban, staff, seller). No impersonate.
5. **Vendor CMS** — Item edit/delete, deposits list/add/withdraw.
6. **Store** — Reviews and warnings (schema already added); store page tabs or subpages.
7. **Transactions** — Payment page: shipping, release, cancel, complete buttons and POST handlers.
8. **Disputes** — Start from payment; dispute detail; admin/staff list.
9. **Support** — Ticket list, new ticket, ticket thread.
10. **PMs** — Messages list, thread, send.
11. **Staff** — Dashboard and all sections (users, stores, tickets, disputes, warnings, deposits, stats, categories).

---

## Doc and Repo

- **Planning (v2):** All v2 planning docs in [planning/v2/](v2/). Binding: **08-PLANNING-DECISIONS-QA.md**.
- **This plan:** `docs/planning/V2.5-BUILD-PLAN.md`.
- **App:** Implement in `app/` (PHP web + API; Python cron unchanged unless new intents require it).
