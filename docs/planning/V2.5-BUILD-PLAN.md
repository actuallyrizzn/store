# V2.5 Build Plan

Clawed Road v2 shipped with core marketplace (browse, buy, orders) and minimal vendor/admin. This plan closes the gap: **nav**, **auth**, **user**, **store**, **vendor CMS**, **PMs**, **support**, **transactions**, **disputes**, and **staff**.

**Reference:** v1 (Tochka) lives in `v1/`; planning docs for v2 are in [planning/v2/](v2/). Implement in `app/` (PHP/Python) per existing LEMP + API patterns.

---

## 1. Nav

**Goal:** Header shows Settings, Referrals, My store, Add item, and wallet balance when logged in; vendor sees store submenu.

| Task | Notes |
|------|--------|
| **Settings** | Link to `/settings/user` (or `/settings.php` user tab). |
| **Referrals** | Link to `/referrals.php` (user referral stats/page). |
| **My store** | Link to current user’s store (resolve store for user → `/store.php?uuid=…`). Show only if user has a store. |
| **Add item** | Link to add-item flow for user’s store (e.g. `/store-admin/…/item/new` or `/item/new.php?store_uuid=…`). Vendor only. |
| **Wallet balance** | In nav or user menu: show EVM balance (or “Wallet” link to wallet page). Requires wallet/balance endpoint or fragment; can be “Wallet” link first, balance later. |

**Implementation:** Extend `web_header.php`: add links when `$currentUser`; if user has store (query `store_users` + `stores`), show My store + Add item; add Settings, Referrals, Wallet. Optional: user dropdown (avatar + menu) instead of flat links.

---

## 2. Auth

**Goal:** Password recovery, invite-code registration, auth admin (users list, login-as, ban, grant staff/seller).

| Task | Notes |
|------|--------|
| **Password recovery** | Flow: `recover.php` (request) → email/token or “reset link” → `recover_step_2.php` (set new password). v1 has 3 steps; MVP can be 2 (request → reset). Need `password_reset_tokens` (or similar) table, token generation, secure reset. |
| **Invite code registration** | `register.php?invite=CODE`; validate code, prefill or restrict registration. Table: `invite_codes` (code, created_by, used_by, used_at) or reuse existing if any. |
| **Auth admin** | Admin-only: list users, ban user, grant staff, grant seller (store). Optional: “login as user” (impersonate) for support. Pages: `admin/users.php` (list), `admin/users.php?uuid=…` (user actions: ban, staff, seller). |

**Implementation:** New scripts: `recover.php`, `recover_step_2.php` (or single page with token in URL). Schema: `password_reset_tokens`, `invite_codes` if not present. Admin: `admin/users.php` (list users from `users`), POST handlers for ban/staff/seller; optional impersonation via session override.

---

## 3. User

**Goal:** Profile/about page, user settings, store settings, referrals page, verification (agreement + plan).

| Task | Notes |
|------|--------|
| **Profile / about** | Public page `/user.php?username=…` (or `/user/{username}`). Show username, join date, maybe feedback count; for vendors link to their store. |
| **User settings** | GET/POST `settings/user.php`: change password, email (if we add it), preferences. |
| **Store settings** | GET/POST `settings/store.php`: storename, description, vendorship re-agree. Only for store owner. |
| **Referrals** | `referrals.php`: list referral link, referred users, referral earnings (if we have referral_payments). |
| **Verification** | Agreement (vendorship): “I agree” + timestamp (already have `vendorship_agreed_at`). Verification plan: optional paid “levels” (gold/silver/bronze) — page `verification/plan.php`, purchase flow if in scope. |

**Implementation:** `user.php` (profile), `settings/user.php`, `settings/store.php`, `referrals.php`. Verification: `verification/agreement.php` (re-agree), `verification/plan.php` (read-only or purchase per config).

---

## 4. Store (vendor)

**Goal:** Store settings (covered in User), reviews page, warnings page.

| Task | Notes |
|------|--------|
| **Store settings** | See User § Store settings. |
| **Reviews page** | `/store.php?uuid=…&tab=reviews` or `/store/reviews.php?uuid=…`. List reviews for store (need `reviews` table or equivalent: rater, store, transaction, score, comment). v1 has `reviews`; if not in v2 schema, add table + API. |
| **Warnings page** | `/store/warnings.php?uuid=…` or store tab. List warnings for store (v1: store_warnings or similar). Add table if missing; list + allow resolve/ack. |

**Implementation:** Schema: `reviews`, `store_warnings` (or reuse v1 naming). Pages: `store/reviews.php`, `store/warnings.php` or tabs on `store.php`.

---

## 5. Vendor CMS

**Goal:** Deposits (add, withdraw), item edit/delete (no new package flows in this slice).

| Task | Notes |
|------|--------|
| **Deposits** | List deposits for my stores (API exists: `api/deposits.php`). Web: `deposits.php` (list), `deposits/add.php` (add), `deposits/withdraw.php?uuid=…` (withdraw). Add/withdraw call API or duplicate logic in PHP. |
| **Item edit** | Form to edit item (name, description, store_uuid). `item/edit.php?uuid=…` GET form, POST save. Owner or store member only. |
| **Item delete** | Soft-delete item (e.g. set `deleted_at`). Button on item edit or list; POST `item/delete.php` or API. |

**Implementation:** `deposits.php`, `deposits/add.php`, `deposits/withdraw.php` (or single page with actions). `item/edit.php`, `item/delete.php` (or POST to edit with action=delete). Reuse API logic or call internal API.

---

## 6. Board & Messages (PMs only)

**Goal:** Private messages only: list conversations, open conversation with a user, send/reply.

| Task | Notes |
|------|--------|
| **PM list** | `messages.php`: list of conversations (distinct peer users) with last message preview, unread count. |
| **PM thread** | `messages.php?username=…`: thread with that user; show messages, form to send. |
| **Schema** | `private_messages` (id, from_user_uuid, to_user_uuid, body, read_at, created_at). Index by (from, to) and (to, from) for listing. |

**Implementation:** Schema: `private_messages`. Pages: `messages.php` (list + thread by query). API optional: `api/messages.php` GET list, GET thread, POST send.

---

## 7. Support

**Goal:** Ticket list, new ticket, ticket thread (view + reply).

| Task | Notes |
|------|--------|
| **Ticket list** | `support.php`: list my tickets (id, subject, status, updated_at). |
| **New ticket** | `support/new.php`: form (subject, message); POST create ticket + first message. |
| **Ticket thread** | `support/ticket.php?id=…`: show messages in ticket; form to add message. Staff can reply and set status. |
| **Schema** | `support_tickets` (id, user_uuid, subject, status, created_at, updated_at), `support_ticket_messages` (id, ticket_id, user_uuid, body, created_at). |

**Implementation:** Schema: `support_tickets`, `support_ticket_messages`. Pages: `support.php`, `support/new.php`, `support/ticket.php`. API: optional GET/POST for tickets and messages.

---

## 8. Transactions

**Goal:** From transaction (payment) page: actions “shipping”, “release”, “cancel”, “complete”.

| Task | Notes |
|------|--------|
| **Shipping** | Vendor marks order shipped (e.g. set shipping status). Button + POST on `payment.php` (or `transaction.php`). |
| **Release** | Vendor releases funds to seller (escrow release). Button + POST. |
| **Cancel** | Buyer or vendor cancels; refund flow. Button + POST. |
| **Complete** | Mark order complete (buyer confirms). Button + POST. |

**Implementation:** Extend `payment.php`: show buttons by role (buyer vs vendor) and current status; POST to same page or `payment/action.php` (action=shipping|release|cancel|complete). Backend: call StatusMachine or equivalent (append status row); for release/cancel trigger or flag for cron if needed.

---

## 9. Disputes

**Goal:** Start dispute, dispute detail (view, status, claims, partial refund), dispute admin list.

| Task | Notes |
|------|--------|
| **Start dispute** | From transaction page: “Open dispute” → form (reason, message) → POST create dispute + first claim. |
| **Dispute detail** | `dispute.php?uuid=…`: show dispute, claims, status; buyer/vendor add claim; staff set status, partial refund. |
| **Dispute admin list** | Staff: `admin/disputes.php` list all disputes; link to dispute detail. |

**Implementation:** Schema: v2 likely has `disputes`, `dispute_claims`. Pages: `dispute.php` (start from payment.php link), `dispute.php?uuid=…` (detail); `admin/disputes.php` (list). API: align with existing `api/disputes.php` if present.

---

## 10. Staff

**Goal:** Full staff panel: users, stores, tickets, disputes, stats, warnings, deposits, and per-user/per-store actions.

| Task | Notes |
|------|--------|
| **Staff dashboard** | `staff.php` or `staff/index.php`: overview links (users, stores, tickets, disputes, warnings, deposits, stats). |
| **Users** | List users; link to user detail (payments, tickets, finance); actions: ban, grant staff, grant seller. |
| **Stores** | List stores; link to store detail (payments, disputes); actions: suspend, allow_to_sell, trusted, account type (gold/silver/bronze/free). |
| **Tickets** | List support tickets; open thread; reply, set status. |
| **Disputes** | List disputes; link to dispute detail; resolve, partial refund. |
| **Warnings** | List store/user warnings; resolve or ack. |
| **Deposits** | List deposits (all or by store); optional actions. |
| **Stats** | Graphs or tables: users over time, vendors, volume, transaction counts. (v1 served PNGs; v2 can do simple HTML tables or charts.) |
| **Item categories** | CRUD for item categories if used in listing. |

**Implementation:** Middleware: require `role in (staff, admin)`. Pages under `staff/`: `staff/index.php`, `staff/users.php`, `staff/users.php?username=…`, `staff/stores.php`, `staff/stores.php?store=…`, `staff/tickets.php`, `staff/disputes.php`, `staff/warnings.php`, `staff/deposits.php`, `staff/stats.php`, `staff/categories.php`. Reuse or mirror v1 staff views; keep LEMP (one script per page or per section).

---

## Order of implementation (suggested)

1. **Nav** — Quick win; extend header with Settings, Referrals, My store, Add item, Wallet.
2. **User** — Profile, user settings, store settings, referrals (and verification agreement if needed).
3. **Auth** — Recovery, invite-code reg, auth admin.
4. **Vendor CMS** — Item edit/delete, deposits list/add/withdraw.
5. **Store** — Reviews and warnings pages (schema first if missing).
6. **Transactions** — Shipping/release/cancel/complete on payment page.
7. **Disputes** — Start, detail, admin list.
8. **Support** — Ticket list, new ticket, thread.
9. **PMs** — List, thread, send.
10. **Staff** — Full panel (dashboard then each section).

---

## Doc and repo

- **Planning (v2):** All v2 planning docs moved to [planning/v2/](v2/).
- **This plan:** `docs/planning/V2.5-BUILD-PLAN.md`.
- **App:** Implement in `app/` (PHP web + API, Python cron unchanged unless needed for new flows).
